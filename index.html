<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Вова-Стандарт: Анализ и Консультации</title>
  <style>
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f7f8fa;
      --bg-tertiary: #f0f2f5;
      --text-primary: #1c1e21;
      --text-secondary: #65676b;
      --border-color: #dce1e7;
      --accent-primary: #0d6efd;
      --accent-primary-hover: #0b5ed7;
      --accent-secondary: #6c757d;
      --accent-secondary-hover: #5a6268;
      --danger-color: #dc3545;
      --success-color: #198754;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
      --border-radius: 8px;
    }

    [data-theme="dark"] {
      --bg-primary: #18191a;
      --bg-secondary: #242526;
      --bg-tertiary: #3a3b3c;
      --text-primary: #e4e6eb;
      --text-secondary: #b0b3b8;
      --border-color: #3e4042;
      --accent-primary: #2374e1;
      --accent-primary-hover: #3982e4;
    }

    .hidden { display: none !important; }

    * { box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      line-height: 1.5;
      transition: background-color 0.2s, color 0.2s;
    }

    .container { max-width: 960px; margin: 20px auto; background-color: var(--bg-primary); border-radius: var(--border-radius); box-shadow: var(--shadow-md); overflow: hidden; }

    header { background-color: var(--bg-primary); color: var(--text-primary); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
    header h1 { margin: 0; font-size: 1.5rem; }
    .header-controls { display: flex; align-items: center; gap: 16px; }
    .model-indicator { font-size: 0.8em; background-color: var(--bg-tertiary); color: var(--text-secondary); padding: 4px 10px; border-radius: 12px; }
    #theme-toggle { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 4px; }
    #theme-toggle svg { width: 20px; height: 20px; }
    .header-logo { height: 48px; width: auto; border-radius: 6px; display: block; }

    .tab-bar { display: flex; border-bottom: 1px solid var(--border-color); background-color: var(--bg-secondary); }
    .tab-link { padding: 14px 20px; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; }
    .tab-link.active { color: var(--accent-primary); border-bottom-color: var(--accent-primary); }

    .tab-content { display: none; padding: 24px; }
    .tab-content.active { display: block; }
    
    label { display: block; margin-bottom: 8px; font-weight: 600; }
    textarea, select { width: 100%; padding: 10px 12px; margin-bottom: 16px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; }
    textarea:focus, select:focus { border-color: var(--accent-primary); outline: none; box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25); }
    textarea { resize: vertical; }

    button { font-size: 1rem; font-weight: 600; padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: background-color 0.2s, box-shadow 0.2s; }
    button:disabled { cursor: not-allowed; opacity: 0.6; }
    button:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25); }
    button svg { width: 18px; height: 18px; }
    .button-primary { background-color: var(--accent-primary); color: white; }
    .button-primary:hover:not(:disabled) { background-color: var(--accent-primary-hover); }
    .button-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
    .button-secondary:hover:not(:disabled) { background-color: var(--border-color); }
    .spinner { border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
    .button-secondary .spinner { border-color: rgba(0,0,0,0.2); border-top-color: var(--text-primary); }
    
    .checkbox-group { margin-bottom: 16px; display: flex; gap: 24px; }
    .checkbox-group label { display: flex; align-items: center; gap: 8px; font-weight: normal; }
    
    .analysis-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #resultsTable { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
    #resultsTable th, #resultsTable td { border: 1px solid var(--border-color); padding: 12px; text-align: left; word-wrap: break-word; }
    #resultsTable th { background-color: var(--bg-secondary); font-weight: 600; }
    #resultsTable a { color: var(--accent-primary); text-decoration: none; }
    #resultsTable a:hover { text-decoration: underline; }

    /* Skeleton Loader */
    .skeleton-loader .skeleton-row { height: 45px; background-color: var(--bg-secondary); border-radius: 6px; margin-bottom: 10px; opacity: 0.7; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    [data-theme="dark"] .skeleton-loader .skeleton-row { background-color: var(--bg-tertiary); }

    /* Chat */
    .chat-window { height: 450px; border: 1px solid var(--border-color); border-radius: var(--border-radius); overflow-y: auto; padding: 16px; margin-bottom: 16px; background-color: var(--bg-secondary); }
    .chat-message { margin-bottom: 16px; max-width: 85%; display: flex; flex-direction: column; }
    .chat-message .sender { font-weight: 600; font-size: 0.9em; margin-bottom: 4px; color: var(--text-secondary); }
    .chat-message .text { padding: 10px 14px; border-radius: 12px; white-space: pre-wrap; word-wrap: break-word; }
    .chat-message.user { align-items: flex-end; margin-left: auto; }
    .chat-message.user .sender { text-align: right; }
    .chat-message.user .text { background-color: var(--accent-primary); color: white; border-bottom-right-radius: 2px; }
    .chat-message.model .text { background-color: var(--bg-tertiary); border-bottom-left-radius: 2px; }
    .chat-message.system .text { background-color: var(--bg-primary); border: 1px dashed var(--border-color); font-size: 0.9em; color: var(--text-secondary); }
    .memory-proposal-buttons { margin-top: 10px; display: flex; gap: 8px; }
    
    .chat-input-area { display: flex; gap: 10px; align-items: flex-start; }
    .chat-input-area textarea { flex-grow: 1; margin: 0; resize: none; }
    .chat-input-area button { flex-shrink: 0; }
    .chat-controls { display: flex; flex-direction: column; gap: 10px; }

    /* Modal */
    .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
    .modal-content { background-color: var(--bg-primary); margin: 10% auto; padding: 24px; border: 1px solid var(--border-color); width: 60%; max-width: 600px; border-radius: var(--border-radius); box-shadow: var(--shadow-md); }
    .modal-content h2 { margin-top: 0; }
    .modal-buttons { margin-top: 16px; display: flex; gap: 10px; justify-content: flex-end; }
    #memoryStatus { margin-top: 16px; font-size: 0.9em; text-align: right; }
    #memoryStatus.success { color: var(--success-color); }
    #memoryStatus.error { color: var(--danger-color); }
    
    @media (max-width: 768px) {
      .container { margin: 0; border-radius: 0; box-shadow: none; }
      header { flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px 16px; }
      .header-logo { height: 40px; }
      .tab-content { padding: 16px; }
      .chat-window { height: 400px; }
      .chat-input-area { flex-direction: column; }
      .chat-controls { flex-direction: row; width: 100%; }
      .chat-controls button { flex-grow: 1; }
      .modal-content { width: 90%; margin: 10% auto; }
    }
  </style>
</head>
<body>

  <div class="container">
    <header>
      <h1>Вова-Стандарт</h1>
      <div class="header-controls">
        <div id="modelIndicator" class="model-indicator">...</div>
        <button id="theme-toggle" title="Переключить тему">
          <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-6.364-.386 1.591-1.591M3 12h2.25m.386-6.364 1.591 1.591M12 12a2.25 2.25 0 0 0-2.25 2.25 2.25 2.25 0 0 0 2.25 2.25 2.25 2.25 0 0 0 2.25-2.25A2.25 2.25 0 0 0 12 12Z" /></svg>
          <svg id="theme-icon-dark" class="hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" /></svg>
        </button>
        <a href="https://nkmehz.com.ua/" target="_blank" rel="noopener noreferrer">
          <img src="https://i.ibb.co/mj0BHFw/zavod-1955.png" alt="Логотип" class="header-logo">
        </a>
      </div>
    </header>

    <div class="tab-bar">
      <div class="tab-link active" data-tab="analysisTab">Анализ стандартов</div>
      <div class="tab-link" data-tab="chatTab">Чат с экспертом</div>
    </div>

    <div id="analysisTab" class="tab-content active">
        <label for="standardsInput">Список стандартов (каждый с новой строки):</label>
        <textarea id="standardsInput" rows="8"></textarea>
        <label for="selectedCountry">Страна:</label>
        <select id="selectedCountry">
          <option value="Украина">Украина</option>
          <option value="Россия">Россия</option>
          <option value="Казахстан">Казахстан</option>
          <option value="Беларусь">Беларусь</option>
          <option value="Международный">Международный</option>
        </select>
        <div class="checkbox-group">
          <label><input type="checkbox" id="replacedByCheckbox"> Показать "Чем заменен"</label>
          <label><input type="checkbox" id="sourcesCheckbox"> Показать "Источник"</label>
        </div>
        <div class="analysis-actions">
          <button id="analyzeButton" class="button-primary">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>
            <span>Анализировать</span>
          </button>
          <button id="memoryButton" class="button-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h8.25M8.25 12h5.25m-5.25 5.25h3M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" /></svg>
            <span>Память ИИ</span>
          </button>
        </div>
      <div id="resultsSection" class="section hidden">
        <h2 style="margin-top: 24px;">Результаты анализа</h2>
        <div style="margin-bottom: 15px; display: flex; gap: 10px;">
          <button id="exportMdButton" class="button-secondary">Экспорт в MD</button>
          <button id="exportCsvButton" class="button-secondary">Экспорт в CSV</button>
        </div>
        <div class="skeleton-loader" id="skeletonLoader">
          <div class="skeleton-row"></div> <div class="skeleton-row"></div> <div class="skeleton-row"></div>
        </div>
        <div style="overflow-x: auto;">
          <table id="resultsTable" class="hidden">
            <thead id="resultsTableHead"></thead>
            <tbody id="resultsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="chatTab" class="tab-content">
      <div class="chat-window" id="chatWindow">
        <div class="chat-message model">
          <div class="sender">Вова-Стандарт</div>
          <div class="text">Здравствуйте! Я ваш ИИ-консультант по вопросам стандартизации. Чем могу помочь?</div>
        </div>
      </div>
      <div class="chat-input-area">
        <textarea id="chatInput" rows="2" placeholder="Введите ваш вопрос..."></textarea>
        <div class="chat-controls">
          <button id="sendMessageButton" class="button-primary" title="Отправить">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z" /></svg>
          </button>
          <button id="clearChatButton" class="button-secondary" title="Очистить чат">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
          </button>
          <button id="exportChatButton" class="button-secondary">Экспорт чата</button>
        </div>
      </div>
    </div>
  </div>

  <div id="memoryModal" class="modal">
    <div class="modal-content">
      <h2>Долговременная память ИИ</h2>
      <p>Эта информация будет использоваться как системная инструкция с высшим приоритетом.</p>
      <textarea id="longTermMemoryInput" rows="10"></textarea>
      <div id="memoryStatus"></div>
      <div class="modal-buttons">
        <button id="closeMemoryModalButton" class="button-secondary">Закрыть</button>
        <button id="saveMemoryButton" class="button-primary">
          <span>Сохранить</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // --- Application State ---
    const app = {
      state: {
        lastAnalysisResults: [],
        chatHistory: [{ role: "model", parts: [{ text: "Здравствуйте! Я ваш ИИ-консультант по вопросам стандартизации. Чем могу помочь?" }] }],
        isLoading: false,
        longTermMemory: '',
        analysisContextNotified: false,
      },
      elements: {}, // To cache DOM elements
    };

    // --- Initialization ---
    window.onload = async () => {
      // Cache elements
      app.elements = {
        modelIndicator: document.getElementById('modelIndicator'),
        chatInput: document.getElementById('chatInput'),
        tabBar: document.querySelector('.tab-bar'),
        analyzeButton: document.getElementById('analyzeButton'),
        memoryButton: document.getElementById('memoryButton'),
        exportMdButton: document.getElementById('exportMdButton'),
        exportCsvButton: document.getElementById('exportCsvButton'),
        sendMessageButton: document.getElementById('sendMessageButton'),
        clearChatButton: document.getElementById('clearChatButton'),
        exportChatButton: document.getElementById('exportChatButton'),
        memoryModal: document.getElementById('memoryModal'),
        closeMemoryModalButton: document.getElementById('closeMemoryModalButton'),
        saveMemoryButton: document.getElementById('saveMemoryButton'),
        longTermMemoryInput: document.getElementById('longTermMemoryInput'),
        memoryStatus: document.getElementById('memoryStatus'),
        resultsSection: document.getElementById('resultsSection'),
        skeletonLoader: document.getElementById('skeletonLoader'),
        resultsTable: document.getElementById('resultsTable'),
        resultsTableHead: document.getElementById('resultsTableHead'),
        resultsTableBody: document.getElementById('resultsTableBody'),
        standardsInput: document.getElementById('standardsInput'),
        replacedByCheckbox: document.getElementById('replacedByCheckbox'),
        sourcesCheckbox: document.getElementById('sourcesCheckbox'),
        selectedCountry: document.getElementById('selectedCountry'),
        chatWindow: document.getElementById('chatWindow'),
      };

      initTheme();
      addEventListeners();
      
      try {
        app.state.longTermMemory = await runGAS('getMemoryProperty');
        const modelName = await runGAS('getModelNameGAS');
        app.elements.modelIndicator.textContent = modelName;
      } catch (err) {
        console.error('Ошибка инициализации:', err.message);
        app.elements.modelIndicator.textContent = 'Ошибка связи';
      }
    };

    function addEventListeners() {
      app.elements.chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); }});
      app.elements.tabBar.addEventListener('click', handleTabClick);
      app.elements.analyzeButton.addEventListener('click', handleAnalyze);
      app.elements.memoryButton.addEventListener('click', openMemoryModal);
      app.elements.exportMdButton.addEventListener('click', handleExportMD);
      app.elements.exportCsvButton.addEventListener('click', handleExportCSV);
      app.elements.sendMessageButton.addEventListener('click', handleSendMessage);
      app.elements.clearChatButton.addEventListener('click', handleClearChat);
      app.elements.exportChatButton.addEventListener('click', handleExportChat);
      app.elements.closeMemoryModalButton.addEventListener('click', closeMemoryModal);
      app.elements.saveMemoryButton.addEventListener('click', saveMemory);
    }

    function handleTabClick(event) {
      const target = event.target.closest('.tab-link');
      if (!target) return;

      const tabName = target.dataset.tab;
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      target.classList.add('active');

      if (tabName === 'chatTab' && app.state.lastAnalysisResults.length > 0 && !app.state.analysisContextNotified) {
        const contextMessage = `Контекст из последнего анализа (${app.state.lastAnalysisResults.length} стандартов) активен. Вы можете задавать вопросы по ним.`
        addMessageToChat('system', contextMessage);
        app.state.analysisContextNotified = true;
      }
    }

    // --- Analysis ---
    async function handleAnalyze() {
      const standardsInput = app.elements.standardsInput.value;
      if (!standardsInput.trim()) return;
      
      setLoading(true, app.elements.analyzeButton);
      app.elements.resultsSection.classList.remove('hidden');
      app.elements.skeletonLoader.classList.remove('hidden');
      app.elements.resultsTable.classList.add('hidden');

      const optionalColumns = {
          replacedBy: app.elements.replacedByCheckbox.checked,
          sources: app.elements.sourcesCheckbox.checked,
      };

      try {
        const results = await runGAS('analyzeStandardsGAS',
          standardsInput.split('\n').filter(s => s.trim()),
          app.elements.selectedCountry.value,
          optionalColumns
        );
        app.state.lastAnalysisResults = results;
        app.state.analysisContextNotified = false; // Reset flag for new analysis
        displayAnalysisResults(results, optionalColumns);
      } catch (err) {
        console.error('Ошибка анализа:', err);
        app.elements.resultsTableBody.innerHTML = `<tr><td colspan="10" style="color: var(--danger-color);">Произошла ошибка: ${err.message}</td></tr>`;
      } finally {
        app.elements.skeletonLoader.classList.add('hidden');
        app.elements.resultsTable.classList.remove('hidden');
        setLoading(false, app.elements.analyzeButton);
      }
    }

    function displayAnalysisResults(results, columns) {
        const { resultsTableHead: thead, resultsTableBody: tbody } = app.elements;
        thead.innerHTML = '';
        tbody.innerHTML = '';

        let headers = ['Запрос', 'Найден', 'Полное наименование', 'Статус'];
        if (columns.replacedBy) headers.push('Чем заменен');
        if (columns.sources) headers.push('Источник');
        headers.push('Примечание ИИ');
        
        const headerRow = thead.insertRow();
        headers.forEach(text => headerRow.insertCell().outerHTML = `<th>${text}</th>`);
        
        if (!results || results.length === 0) {
          tbody.innerHTML = `<tr><td colspan="${headers.length}">Нет данных для отображения. ИИ вернул пустой результат.</td></tr>`;
          return;
        }

        results.forEach(item => {
            const row = tbody.insertRow();
            row.insertCell().textContent = item.requestedDesignation || '–';
            row.insertCell().textContent = item.exists || '–';
            row.insertCell().textContent = item.fullName || '–';
            row.insertCell().textContent = item.status || '–';
            if (columns.replacedBy) row.insertCell().textContent = item.replacedBy || '–';
            if (columns.sources) {
              const cell = row.insertCell();
              const sources = Array.isArray(item.sources) ? item.sources : [item.sources];
              const linksHtml = sources.map(source => {
                  const sourceText = String(source || '');
                  if (!sourceText.trim() || sourceText === 'null') return '';
                  return sourceText.startsWith('http') 
                    ? `<a href="${sourceText}" target="_blank" rel="noopener noreferrer">${escapeHtml(sourceText)}</a>`
                    : escapeHtml(sourceText);
                }).filter(Boolean).join('<br>');
              cell.innerHTML = linksHtml || '–';
            }
            row.insertCell().textContent = item.aiNote || '–';
        });
        app.elements.resultsSection.classList.remove('hidden');
    }
    
    // --- Chat ---
    async function handleSendMessage() {
      const message = app.elements.chatInput.value.trim();
      if (!message || app.state.isLoading) return;
      
      app.elements.chatInput.value = '';
      addMessageToChat('user', message);
      app.state.chatHistory.push({ role: 'user', parts: [{ text: message }] });
      setLoading(true, app.elements.sendMessageButton);
      
      const analysisContext = app.state.lastAnalysisResults.length > 0
        ? JSON.stringify(app.state.lastAnalysisResults, null, 2)
        : '';
      
      try {
        let responseText = await runGAS('chatWithExpertGAS', app.state.chatHistory, analysisContext);

        try {
          const command = JSON.parse(responseText);
          if (command.action === 'propose_memory_update' && command.data) {
            renderMemoryProposal(command.data);
          } else {
            addMessageToChat('model', responseText);
            app.state.chatHistory.push({ role: 'model', parts: [{ text: responseText }] });
          }
        } catch (e) {
          addMessageToChat('model', responseText);
          app.state.chatHistory.push({ role: 'model', parts: [{ text: responseText }] });
        }
      } catch (err) {
        console.error('Ошибка чата:', err);
        addMessageToChat('model', `Произошла ошибка: ${err.message}`);
      } finally {
        setLoading(false, app.elements.sendMessageButton);
      }
    }

    function addMessageToChat(role, text, isHtml = false) {
        const { chatWindow } = app.elements;
        const senderName = role === 'user' ? 'Вы' : (role === 'system' ? 'Система' : 'Вова-Стандарт');
        const msgHtml = `
          <div class="chat-message ${role}">
            <div class="sender">${senderName}</div>
            <div class="text">${isHtml ? text : escapeHtml(text)}</div>
          </div>`;
        chatWindow.insertAdjacentHTML('beforeend', msgHtml);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function renderMemoryProposal(data) {
      const proposalId = `proposal-${Date.now()}`;
      const escapedData = escapeHtml(data);
      const proposalHtml = `
        <p>ИИ предлагает сохранить в долговременную память:</p>
        <blockquote>"${escapedData}"</blockquote>
        <div class="memory-proposal-buttons" id="${proposalId}">
          <button class="button-primary" style="background-color: var(--success-color);">Сохранить</button>
          <button class="button-secondary">Отклонить</button>
        </div>
      `;
      addMessageToChat('system', proposalHtml, true);
      
      const proposalElement = document.getElementById(proposalId);
      proposalElement.querySelector('.button-primary').addEventListener('click', () => handleMemoryConfirm(data, proposalElement), { once: true });
      proposalElement.querySelector('.button-secondary').addEventListener('click', () => handleMemoryReject(proposalElement), { once: true });
    }

    async function handleMemoryConfirm(data, proposalElement) {
        const confirmButton = proposalElement.querySelector('.button-primary');
        setLoading(true, confirmButton);
        try {
            const currentMemory = await runGAS('getMemoryProperty');
            const newMemory = currentMemory ? `${currentMemory}\n- ${data}` : `- ${data}`;
            await runGAS('setMemoryProperty', newMemory);
            app.state.longTermMemory = newMemory;
            addMessageToChat('system', `✅ Информация сохранена в памяти.`);
            app.state.chatHistory.push({ role: 'model', parts: [{ text: `Хорошо, я запомнил: "${data}"` }] });
        } catch (err) {
            addMessageToChat('system', `❌ Не удалось сохранить память: ${err.message}`);
        } finally {
            if (proposalElement) proposalElement.remove();
        }
    }

    function handleMemoryReject(proposalElement) {
        addMessageToChat('system', `Сохранение отменено.`);
        app.state.chatHistory.push({ role: 'model', parts: [{ text: 'Понял, сохранение отменено.' }] });
        if (proposalElement) proposalElement.remove();
    }
    
    function handleClearChat() {
        if (confirm('Вы уверены, что хотите очистить историю чата?')) {
            app.elements.chatWindow.innerHTML = `
            <div class="chat-message model">
                <div class="sender">Вова-Стандарт</div>
                <div class="text">Здравствуйте! Я ваш ИИ-консультант по вопросам стандартизации. Чем могу помочь?</div>
            </div>`;
            app.state.chatHistory = [{ role: "model", parts: [{ text: "Здравствуйте! Я ваш ИИ-консультант по вопросам стандартизации. Чем могу помочь?" }] }];
        }
    }

    // --- Memory Modal ---
    function openMemoryModal() {
      app.elements.longTermMemoryInput.value = app.state.longTermMemory;
      app.elements.memoryStatus.textContent = '';
      app.elements.memoryStatus.className = '';
      app.elements.memoryModal.style.display = 'block';
    }

    function closeMemoryModal() {
      app.elements.memoryModal.style.display = 'none';
    }

    async function saveMemory() {
      const { saveMemoryButton, longTermMemoryInput, memoryStatus } = app.elements;
      const newMemory = longTermMemoryInput.value;
      
      setLoading(true, saveMemoryButton);
      memoryStatus.textContent = '';
      memoryStatus.className = '';

      try {
        await runGAS('setMemoryProperty', newMemory);
        app.state.longTermMemory = newMemory;
        memoryStatus.textContent = 'Сохранено успешно!';
        memoryStatus.className = 'success';
        setTimeout(closeMemoryModal, 1000);
      } catch (err) {
        memoryStatus.textContent = 'Ошибка сохранения: ' + err.message;
        memoryStatus.className = 'error';
      } finally {
        setLoading(false, saveMemoryButton);
      }
    }
    
    // --- Export ---
    function downloadFile(content, filename, mimeType) {
      const a = document.createElement('a');
      const blob = new Blob([content], { type: mimeType });
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function handleExportMD() {
      if (app.state.lastAnalysisResults.length === 0) return;
      const headers = Array.from(document.querySelectorAll('#resultsTableHead th')).map(th => th.textContent);
      const keyMap = {'Запрос': 'requestedDesignation', 'Найден': 'exists', 'Полное наименование': 'fullName', 'Статус': 'status', 'Чем заменен': 'replacedBy', 'Источник': 'sources', 'Примечание ИИ': 'aiNote' };
      
      let mdContent = `| ${headers.join(' | ')} |\n`;
      mdContent += `| ${headers.map(() => '---').join(' | ')} |\n`;
      
      app.state.lastAnalysisResults.forEach(item => {
        const rowData = { ...item };
        if (Array.isArray(rowData.sources)) {
            rowData.sources = rowData.sources.join(', ');
        }
        const row = headers.map(header => {
            const cellValue = rowData[keyMap[header]] || '';
            return String(cellValue).replace(/\|/g, '\\|');
        });
        mdContent += `| ${row.join(' | ')} |\n`;
      });

      downloadFile(mdContent, 'analysis_results.md', 'text/markdown;charset=utf-8,');
    }

    function handleExportCSV() {
      if (app.state.lastAnalysisResults.length === 0) return;
      const headers = Array.from(document.querySelectorAll('#resultsTableHead th')).map(th => th.textContent);
      const keyMap = {'Запрос': 'requestedDesignation', 'Найден': 'exists', 'Полное наименование': 'fullName', 'Статус': 'status', 'Чем заменен': 'replacedBy', 'Источник': 'sources', 'Примечание ИИ': 'aiNote' };
      
      const escapeCsvCell = (cell) => {
        const str = String(cell == null ? '' : cell);
        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
          return `"${str.replace(/"/g, '""')}"`;
        }
        return str;
      };

      let csvContent = headers.join(',') + '\n';
      app.state.lastAnalysisResults.forEach(item => {
        const rowData = { ...item };
        if (Array.isArray(rowData.sources)) {
          rowData.sources = rowData.sources.join('; ');
        }
        const row = headers.map(header => escapeCsvCell(rowData[keyMap[header]]));
        csvContent += row.join(',') + '\n';
      });

      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
      downloadFile(new Blob([bom, csvContent]), 'analysis_results.csv', 'text/csv;charset=utf-8,');
    }

    function handleExportChat() {
      if (app.state.chatHistory.length <= 1) return;
      
      let mdContent = `# История диалога с Вова-Стандарт\n\n`;
      app.state.chatHistory.slice(1).forEach(message => {
        const sender = message.role === 'user' ? 'Вы' : 'Вова-Стандарт';
        const text = message.parts[0].text;
        mdContent += `**${sender}:**\n\n${text}\n\n---\n\n`;
      });
      
      downloadFile(mdContent, 'chat_history.md', 'text/markdown;charset=utf-8,');
    }

    // --- Utilities ---
    function escapeHtml(text) {
        if (typeof text !== 'string') return '';
        return text.replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'})[m]);
    }

    function setLoading(state, button) {
      app.state.isLoading = state;
      button.disabled = state;
      const spinner = button.querySelector('.spinner');
      const text = button.querySelector('span');

      if (state) {
        if (text) text.style.display = 'none';
        if (!spinner) {
          const newSpinner = document.createElement('div');
          newSpinner.className = 'spinner';
          button.prepend(newSpinner);
        } else {
          spinner.style.display = 'block';
        }
      } else {
        if (text) text.style.display = 'inline';
        if (spinner) spinner.style.display = 'none';
      }
    }

    function initTheme() {
        const themeToggle = document.getElementById('theme-toggle');
        const lightIcon = document.getElementById('theme-icon-light');
        const darkIcon = document.getElementById('theme-icon-dark');
        const savedTheme = localStorage.getItem('theme') || 'dark';

        document.documentElement.setAttribute('data-theme', savedTheme);
        if (savedTheme === 'dark') {
            lightIcon.classList.add('hidden');
            darkIcon.classList.remove('hidden');
        }

        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            lightIcon.classList.toggle('hidden', newTheme === 'dark');
            darkIcon.classList.toggle('hidden', newTheme === 'light');
        });
    }
    
    function runGAS(functionName, ...args) {
      return new Promise((resolve, reject) => {
        let attempt = 0;
        const maxAttempts = 5;
        const delay = 500; // ms

        function tryCall() {
          if (typeof google !== 'undefined' && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              [functionName](...args);
          } else {
            attempt++;
            if (attempt < maxAttempts) {
              console.warn(`google.script.run not ready. Retrying in ${delay}ms... (Attempt ${attempt}/${maxAttempts})`);
              setTimeout(tryCall, delay);
            } else {
              const error = new Error('Не удалось подключиться к серверной части Google Apps Script. Попробуйте обновить страницу.');
              console.error(error.message);
              reject(error);
            }
          }
        }
        
        tryCall();
      });
    }
  </script>
</body>
</html>